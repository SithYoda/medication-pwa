<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Manager</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-capsule"></i> Medication Manager
            </span>
            <div>
                <span id="currentUserName" class="text-white me-2" style="display: none;"></span>
                <button class="btn btn-outline-light btn-sm me-2" id="logoutBtn" style="display: none;">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
                <button class="btn btn-outline-light btn-sm" id="settingsBtn">
                    <i class="bi bi-gear"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid p-3">
        
        <!-- Login Section -->
        <div id="loginSection" class="card shadow-sm mx-auto" style="max-width: 500px; display: none;">
            <div class="card-body text-center p-4">
                <h2 class="mb-3"><i class="bi bi-lock"></i> Login</h2>
                <p class="text-muted mb-4">Sign in with your Google account to continue</p>
                
                <!-- Google Sign-In Button -->
                <div id="g_id_onload"
                     data-client_id="769304845593-ri53r3bcsugr1trjgksgt8rjntevpbid.apps.googleusercontent.com"
                     data-callback="handleGoogleLogin"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin" 
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="sign_in_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>
                
                <!-- Login Error Display -->
                <div id="loginError" class="alert alert-danger mt-3" style="display: none; text-align: left;">
                    <!-- Error message will be inserted here -->
                </div>
            </div>
        </div>

        <!-- User Selection -->
        <div id="userSelection" class="card shadow-sm mb-3" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">Select User</h5>
                <div class="row">
                    <div class="col-md-8">
                        <select class="form-select" id="userSelect">
                            <option value="">Select a user...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" id="loadUserBtn">
                            <i class="bi bi-arrow-right-circle"></i> Load Medications
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row g-2 mb-3" id="summarySection" style="display: none;">
            <div class="col-4">
                <div class="card text-center">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-1">Total Meds</h6>
                        <h3 class="mb-0" id="totalMeds">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center bg-warning">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-1">Low Stock</h6>
                        <h3 class="mb-0" id="lowStockCount">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center bg-danger text-white">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-1">Critical</h6>
                        <h3 class="mb-0" id="criticalCount">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-3" id="mainTabs" style="display: none;">
            <li class="nav-item">
                <a class="nav-link" id="medsTab" href="#" data-tab="medications">
                    <i class="bi bi-list-ul"></i> Medications
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" id="forecastTab" href="#" data-tab="forecast">
                    <i class="bi bi-calendar-event"></i> Forecast
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="timelineTab" href="#" data-tab="timeline">
                    <i class="bi bi-calendar3"></i> Timeline
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="manageTab" href="#" data-tab="manage">
                    <i class="bi bi-gear-fill"></i> Manage
                </a>
            </li>
            <!-- ADD THIS NEW TAB -->
            <li class="nav-item">
                <a class="nav-link" id="pharmaciesTab" href="#" data-tab="pharmacies">
                    <i class="bi bi-shop"></i> Pharmacies
                </a>
            </li>
        </ul>

        <!-- Medications List -->
        <div id="medicationsList" class="content-section" style="display: none;">
            <!-- Medication cards will be dynamically added here -->
        </div>

        <!-- Forecast View -->
        <div id="forecastView" class="content-section" style="display: none;">
            <!-- Forecast Summary -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="card-title mb-0">Next Purchase</h5>
                        <!-- ADD THIS SHARE BUTTON -->
                        <button class="btn btn-outline-primary btn-sm" id="shareForecastBtn">
                            <i class="bi bi-share"></i> Share
                        </button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 id="nextPurchaseDate" class="mb-0">-</h3>
                            <small class="text-muted">Estimated Cost: <strong id="estimatedCost">$0.00</strong></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forecast List -->
            <div id="forecastList">
                <!-- Forecast items will be dynamically added here -->
            </div>
        </div>

        <!-- Timeline View -->
        <div id="timelineView" class="content-section" style="display: none;">
            <!-- Month Selector -->
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Forecast Period</h5>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="timelineMonths" id="timeline3" value="3">
                        <label class="btn btn-outline-primary" for="timeline3">3 Months</label>
                        
                        <input type="radio" class="btn-check" name="timelineMonths" id="timeline6" value="6" checked>
                        <label class="btn btn-outline-primary" for="timeline6">6 Months</label>
                        
                        <input type="radio" class="btn-check" name="timelineMonths" id="timeline12" value="12">
                        <label class="btn btn-outline-primary" for="timeline12">12 Months</label>
                    </div>
                </div>
            </div>
            
            <!-- Timeline Summary -->
            <div class="row g-2 mb-3" id="timelineSummary">
                <div class="col-6">
                    <div class="card text-center">
                        <div class="card-body p-2">
                            <h6 class="card-title mb-1">Total Purchases</h6>
                            <h3 class="mb-0" id="totalPurchases">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card text-center bg-warning">
                        <div class="card-body p-2">
                            <h6 class="card-title mb-1">Scripts Needed</h6>
                            <h3 class="mb-0" id="totalPrescriptions">0</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="card mb-3">
                <div class="card-body p-2">
                    <small>
                        <span class="badge bg-success me-2"><i class="bi bi-cart"></i> Purchase</span>
                        <span class="badge bg-danger"><i class="bi bi-file-medical"></i> New Script Needed</span>
                    </small>
                </div>
            </div>
            
            <!-- Timeline Events -->
            <div id="timelineEvents">
                <!-- Events will be dynamically added here -->
            </div>
        </div>

        <!-- Manage Medications View -->
        <div id="manageView" class="content-section" style="display: none;">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Manage Medications</h5>
                        <button class="btn btn-success btn-sm" id="addMedicationBtn">
                            <i class="bi bi-plus-circle"></i> Add Medication
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="manageMedicationsList">
                <!-- Management cards will be dynamically added here -->
            </div>
        </div>

        <!-- Pharmacies View -->
        <div id="pharmaciesView" class="content-section" style="display: none;">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Manage Pharmacies</h5>
                        <button class="btn btn-success btn-sm" id="addPharmacyBtn">
                            <i class="bi bi-plus-circle"></i> Add Pharmacy
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="pharmaciesList">
                <!-- Pharmacy cards will be dynamically added here -->
            </div>
        </div>

    </div>

    <!-- Medication Detail Modal -->
    <div class="modal fade" id="medDetailModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMedName">Medication Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>Common Name:</strong>
                        <span id="modalCommonName"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Strength:</strong>
                        <span id="modalStrength"></span>
                    </div>
                    
                    <!-- Low Repeats Warning -->
                    <div id="repeatsWarning" class="alert alert-warning" style="display: none;">
                        <!-- Warning message will be inserted here -->
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Current Stock</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="modalStock" readonly>
                            <span class="input-group-text">units</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Repeats Remaining</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="modalRepeats" readonly>
                            <span class="input-group-text">prescriptions</span>
                        </div>
                    </div>
                    
                    <!-- ADD THESE DOSAGE FIELDS -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Dosage Schedule</label>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label small">AM</label>
                                <input type="number" step="0.5" class="form-control form-control-sm" id="modalDosageAM" readonly>
                            </div>
                            <div class="col-4">
                                <label class="form-label small">PM</label>
                                <input type="number" step="0.5" class="form-control form-control-sm" id="modalDosagePM" readonly>
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Weekly</label>
                                <input type="number" step="0.5" class="form-control form-control-sm" id="modalDosageWeekly" readonly>
                            </div>
                        </div>
                        <small class="text-muted">Daily total: <strong id="modalDosageTotal">0</strong> tablets/day</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Days Remaining</label>
                        <input type="text" class="form-control" id="modalDaysRemaining" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Run Out Date</label>
                        <input type="text" class="form-control" id="modalRunOutDate" readonly>
                    </div>
                    
                    <hr>
                    
                    <!-- Normal Mode Buttons -->
                    <div id="normalModeButtons" class="d-grid gap-2">
                        <button class="btn btn-outline-primary" id="recordUsageBtn">
                            <i class="bi bi-dash-circle"></i> Record Usage
                        </button>
                        <button class="btn btn-success" id="recordPurchaseBtn">
                            <i class="bi bi-plus-circle"></i> Record Purchase
                        </button>
                        <button class="btn btn-outline-secondary" id="editModeBtn">
                            <i class="bi bi-pencil"></i> Edit Stock/Repeats/Dosage
                        </button>
                    </div>
                    
                    <!-- Edit Mode Buttons -->
                    <div id="editModeButtons" class="d-grid gap-2" style="display: none;">
                        <button class="btn btn-primary" id="saveEditsBtn">
                            <i class="bi bi-check-circle"></i> Save Changes
                        </button>
                        <button class="btn btn-outline-secondary" id="cancelEditBtn">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Medication Form Modal -->
    <div class="modal fade" id="medicationFormModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="medicationFormTitle">Add Medication</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editMedId">
                    
                    <div class="mb-3">
                        <label class="form-label">Medication Name *</label>
                        <input type="text" class="form-control" id="medName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Common Name *</label>
                        <input type="text" class="form-control" id="medCommonName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Strength *</label>
                        <input type="text" class="form-control" id="medStrength" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Quantity per Repeat *</label>
                        <input type="number" class="form-control" id="medQtyRepeat" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Price</label>
                        <input type="number" step="0.01" class="form-control" id="medPrice">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveMedicationBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pharmacy Form Modal -->
    <div class="modal fade" id="pharmacyFormModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pharmacyFormTitle">Add Pharmacy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editPharmacyId">
                    
                    <div class="mb-3">
                        <label class="form-label">Pharmacy Name *</label>
                        <input type="text" class="form-control" id="pharmacyName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="pharmacyPhone">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Fax</label>
                        <input type="tel" class="form-control" id="pharmacyFax">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="pharmacyEmail">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="pharmacyAddress" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="savePharmacyBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Medication Modal -->
    <div class="modal fade" id="assignMedicationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus"></i> Assign Medication
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Assigning to:</strong> <span id="assignToUserName"></span><br>
                        <strong>Medication:</strong> <span id="assignMedName"></span>
                    </div>
                    
                    <input type="hidden" id="assignMedId">
                    
                    <div class="mb-3">
                        <label class="form-label">Current Stock *</label>
                        <input type="number" class="form-control" id="assignInitialStock" value="0" min="0" required>
                        <small class="text-muted">How many tablets/doses do they currently have?</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Prescription Repeats *</label>
                        <input type="number" class="form-control" id="assignRepeats" value="0" min="0" required>
                        <small class="text-muted">How many repeats are left on their prescription?</small>
                    </div>
                    
                    <hr>
                    <h6>Dosage Schedule</h6>
                    
                    <div class="mb-3">
                        <label class="form-label">Morning Dose (AM)</label>
                        <input type="number" step="0.5" class="form-control" id="assignDosageAM" value="0" min="0">
                        <small class="text-muted">Number of tablets in the morning</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Evening Dose (PM)</label>
                        <input type="number" step="0.5" class="form-control" id="assignDosagePM" value="0" min="0">
                        <small class="text-muted">Number of tablets in the evening</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Once Per Week</label>
                        <input type="number" step="0.5" class="form-control" id="assignDosageWeekly" value="0" min="0">
                        <small class="text-muted">Number of tablets once per week (leave 0 if daily)</small>
                    </div>
                    
                    <div class="alert alert-warning">
                        <small><i class="bi bi-info-circle"></i> At least one dosage value must be greater than 0</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmAssignBtn">Assign Medication</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">API URL</label>
                        <input type="text" class="form-control" id="apiUrlInput" 
                               value="https://darthyoda.pythonanywhere.com">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSettingsBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-share"></i> Share Medication Order
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Order Summary -->
                    <div id="shareOrderSummary" class="mb-3">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <!-- Share Options -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" id="shareEmailBtn">
                            <i class="bi bi-envelope"></i> Email
                        </button>
                        <button class="btn btn-outline-success" id="shareSMSBtn">
                            <i class="bi bi-phone"></i> SMS
                        </button>
                        <button class="btn btn-outline-info" id="copyToClipboardBtn">
                            <i class="bi bi-clipboard"></i> Copy to Clipboard
                        </button>
                        <button class="btn btn-outline-secondary" id="showQRCodeBtn">
                            <i class="bi bi-qr-code"></i> Generate QR Code
                        </button>
                    </div>
                    
                    <!-- QR Code Display -->
                    <div id="qrCodeContainer" class="text-center mt-3" style="display: none;">
                        <canvas id="qrCodeCanvas"></canvas>
                        <p class="text-muted mt-2"><small>Scan this QR code to view order details</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Custom Alert/Confirm Modal -->
    <div class="modal fade" id="customAlertModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-capsule"></i> Medication Manager
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="customAlertBody">
                    <!-- Message will be inserted here -->
                </div>
                <div class="modal-footer" id="customAlertFooter">
                    <!-- Buttons will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- App JS -->
    <script src="app.js"></script>

</body>
</html>